<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy GO !</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        .facility-dot { width: 12px; height: 12px; background: #FFBF00; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .user-dot { width: 16px; height: 16px; background: #3B82F6; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        
        /* ä¿®æ­£å¾Œçš„å®šä½éµä½ç½®ï¼šæ¨™ç±¤åˆ—ä¸‹æ–¹ */
        .locate-btn {
            position: fixed; right: 20px; top: 150px; z-index: 1000;
            width: 50px; height: 50px; background: white; border-radius: 50%;
            display: flex; items-center; justify-center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none; cursor: pointer;
        }
    </style>
</head>
<body>

    <div style="position:fixed; top:80px; left:0; right:0; z-index:1000; display:flex; gap:10px; padding:0 20px; overflow-x:auto;">
        <button onclick="updateData('baby_care')" style="white-space:nowrap; padding:8px 16px; border-radius:20px; border:none; background:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">ğŸ¼ å“ºä¹³å®¤</button>
        <button onclick="updateData('toilets')" style="white-space:nowrap; padding:8px 16px; border-radius:20px; border:none; background:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">ğŸš¾ å…¬å»</button>
    </div>

    <button class="locate-btn" onclick="locateUser()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2"><path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/><circle cx="12" cy="12" r="3"/></svg>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°åœ–ï¼ˆä¸è¨­é è¨­ä¸­å¿ƒé»ï¼Œç­‰å¾…å®šä½ï¼‰
        const map = L.map('map', { zoomControl: false, attributionControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let facilityLayer = L.layerGroup().addTo(map);
        let userMarker = null;

        function locateUser() {
            // å•Ÿç”¨é«˜ç²¾ç¢ºåº¦å®šä½
            map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: true });
        }

        // ç•¶å®šä½æˆåŠŸæ™‚çš„è™•ç†
        map.on('locationfound', function(e) {
            console.log("å®šä½æˆåŠŸ:", e.latlng);
            
            // 1. æ›´æ–°æˆ–å»ºç«‹ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(e.latlng, {
                icon: L.divIcon({ className: 'user-dot', iconSize: [16, 16] })
            }).addTo(map);

            // 2. å¼·åˆ¶åœ°åœ–ç§»å‹•åˆ°è©²åº§æ¨™
            map.panTo(e.latlng);

            // 3. ç«‹å³è¼‰å…¥ 10km å…§çš„å…¨çƒæ•¸æ“š
            updateData('baby_care');
        });

        map.on('locationerror', function(e) {
            alert("å®šä½å¤±æ•—ï¼šè«‹æª¢æŸ¥æ‰‹æ©Ÿæ˜¯å¦é–‹å•Ÿ GPS ä¸¦å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®ã€‚");
        });

        async function updateData(type) {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            
            // å…¨çƒ Overpass API æŸ¥è©¢èªæ³•
            let tag = 'nwr["amenity"~"baby_hatch|changing_room"];'; 
            if(type === 'toilets') tag = 'nwr["amenity"="toilets"];';
            
            const query = `[out:json][timeout:25];(${tag});out center(${sw.lat},${sw.lng},${ne.lat},${ne.lng});`;
            const url = `https://overpass-api.de/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                facilityLayer.clearLayers();
                
                data.elements.forEach(el => {
                    const lat = el.lat || (el.center && el.center.lat);
                    const lon = el.lon || (el.center && el.center.lon);
                    if (lat && lon) {
                        L.marker([lat, lon], {
                            icon: L.divIcon({ className: 'facility-dot', iconSize: [12, 12] })
                        }).addTo(facilityLayer);
                    }
                });
            } catch (err) {
                console.error("è¼‰å…¥å¤±æ•—", err);
            }
        }

        // é é¢é–‹å•Ÿè‡ªå‹•å•Ÿå‹•
        window.onload = locateUser;
    </script>
</body>
</html>

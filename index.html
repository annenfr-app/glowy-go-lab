<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Glowy GO ! Core</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --g-teal: #00838f; --amber: #FFBF00; --google-gray: #70757a; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, "SF Pro Display", sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; background: #f8f9fa; }

        /* ğŸŸ¢ é ‚éƒ¨ä»‹é¢ï¼šç²¾ç¢ºå°é½Š Gmaps é‚è¼¯ */
        .top-interface { position: absolute; top: calc(env(safe-area-inset-top) + 12px); left: 12px; right: 12px; z-index: 1000; pointer-events: none; }
        .search-bar-row { display: flex; align-items: center; gap: 8px; pointer-events: auto; }
        
        .search-container { 
            flex: 1; background: white; height: 48px; border-radius: 24px; 
            display: flex; align-items: center; padding: 0 16px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
        }
        .search-container input { flex: 1; border: none; outline: none; font-size: 16px; margin-left: 8px; color: #202124; }
        
        .profile-btn { 
            width: 45px; height: 45px; border-radius: 50%; background: #fff; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white; 
            overflow: hidden; cursor: pointer; pointer-events: auto;
        }

        /* æ©«å‘æ¨™ç±¤åˆ— */
        .tag-scroller { display: flex; gap: 8px; overflow-x: auto; margin-top: 12px; pointer-events: auto; -webkit-overflow-scrolling: touch; }
        .tag-scroller::-webkit-scrollbar { display: none; }
        .tag { 
            background: white; padding: 7px 16px; border-radius: 18px; 
            white-space: nowrap; font-size: 14px; font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; border: 1px solid transparent;
        }
        .tag.active { border-color: var(--g-teal); color: var(--g-teal); }

        /* ğŸŸ¢ å³å´ï¼šåƒ…ä¿ç•™å®šä½éˆ• */
        .gps-fab { 
            position: absolute; right: 16px; bottom: 180px; z-index: 1000; 
            width: 54px; height: 54px; border-radius: 27px; background: white; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.2); border: none; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* ğŸŸ¢ åº•éƒ¨æŠ½å±œ (Bottom Sheet) */
        .bottom-drawer { 
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 2000; 
            background: white; border-radius: 16px 16px 0 0; 
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1); 
        }
        .drawer-handle { width: 36px; height: 4px; background: #e0e0e0; border-radius: 2px; margin: 10px auto; }
        .drawer-content { padding: 0 20px 15px; }
        .loc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .loc-header h2 { margin: 0; font-size: 22px; letter-spacing: -0.5px; }
        .weather-status { text-align: right; font-size: 12px; color: var(--google-gray); line-height: 1.4; }

        /* å°è¦½åˆ†é  */
        .nav-bar { display: flex; border-top: 1px solid #f1f3f4; padding-bottom: env(safe-area-inset-bottom); height: 72px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #5f6368; font-size: 10px; text-decoration: none; }
        .nav-item.active { color: var(--g-teal); }
        .nav-icon { font-size: 22px; margin-bottom: 3px; }

        /* çœŸå¯¦é»ä½æ¨£å¼ (ç¥ç€è‰²æ´»å‹•é») */
        .amber-marker { background: var(--amber); border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-interface">
        <div class="search-bar-row">
            <div class="search-container">
                <span>ğŸ”</span>
                <input type="text" id="search-input" placeholder="åœ¨æ­¤æœå°‹åœ°é»æˆ–æ´»å‹•..." onkeypress="if(event.key==='Enter') searchLocation()">
            </div>
            <div class="profile-btn" onclick="toggleProfile()">
                <img src="https://api.dicebear.com/7.x/micah/svg?seed=Glowy" style="width:100%" alt="User">
            </div>
        </div>
        <div class="tag-scroller">
            <div class="tag active" onclick="fetchRealData('events')">ğŸ¡ æ´»å‹•</div>
            <div class="tag" onclick="fetchRealData('nursing')">ğŸ¼ å“ºä¹³å®¤</div>
            <div class="tag" onclick="fetchRealData('friendly')">â˜• è¦ªå­å‹å–„</div>
        </div>
    </div>

    <button class="gps-fab" onclick="getMyLocation()">ğŸ¯</button>

    <div class="bottom-drawer">
        <div class="drawer-handle"></div>
        <div class="drawer-content">
            <div class="loc-header">
                <h2 id="current-location-name">å°åŒ—å¸‚</h2>
                <div class="weather-status" id="weather-data">
                    ğŸŒ¡ï¸ 24Â°C<br><span style="color:#4CAF50;">â— AQI å„ªè‰¯</span>
                </div>
            </div>
            <div id="dynamic-content" style="min-height: 20px; font-size: 14px; color: #5f6368;">
                æ¢ç´¢é™„è¿‘çš„è¦ªå­ç¤¾äº¤æ´»å‹•...
            </div>
        </div>
        <nav class="nav-bar">
            <a href="#" class="nav-item active"><span class="nav-icon">ğŸ“</span>æ¢ç´¢</a>
            <a href="#" class="nav-item"><span class="nav-icon">ğŸ‘¤</span>å€‹äººä¸­å¿ƒ</a>
            <a href="#" class="nav-item"><span class="nav-icon">ï¼‹</span>è²¢ç»</a>
            <a href="#" class="nav-item"><span class="nav-icon">ğŸª</span>æœå‹™</a>
        </nav>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°åœ– - é è¨­å°åŒ— (ä¹Ÿå¯æ”¹å·´é»)
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.0339, 121.5644], 15);
        
        // ä»‹æ¥çœŸå¯¦åº•åœ–ï¼šCartoDB Light (æœ€æ¥è¿‘ Gmaps ä¹¾æ·¨è¦–è¦º)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const dataLayer = L.layerGroup().addTo(map);

        // ğŸŸ¢ 1. çœŸå¯¦æœå°‹ä»‹æ¥ (Nominatim)
        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            if(!query) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if(data.length > 0) {
                map.setView([data[0].lat, data[0].lon], 16);
                updateUIInfo(data[0].lat, data[0].lon, data[0].display_name);
            }
        }

        // ğŸŸ¢ 2. çœŸå¯¦å®šä½åŠŸèƒ½
        function getMyLocation() {
            map.locate({setView: true, maxZoom: 16});
        }

        map.on('locationfound', (e) => {
            L.circle(e.latlng, { radius: e.accuracy / 2 }).addTo(map);
            L.circleMarker(e.latlng, { radius: 8, fillColor: '#4285F4', color: 'white', weight: 3, fillOpacity: 1 }).addTo(map);
        });

        // ğŸŸ¢ 3. çœŸå¯¦æ•¸æ“šç²å–é‚è¼¯ (æ´»å‹•/è¨­æ–½)
        async function fetchRealData(type) {
            dataLayer.clearLayers();
            const center = map.getCenter();
            
            // é€™è£¡ä»‹æ¥æ”¿åºœ Open Data æˆ–å¾Œç«¯ API
            // ä»¥ä¸‹ç‚º API ä¸²æ¥çµæ§‹ç¯„ä¾‹ (ä»¥å°åŒ—å¸‚ç‚ºä¾‹)
            document.getElementById('dynamic-content').innerText = `æ­£åœ¨è¼‰å…¥é™„è¿‘çš„${type === 'events' ? 'æ´»å‹•' : 'è¨­æ–½'}...`;

            // ç¯„ä¾‹ï¼šå¦‚æœ type æ˜¯å“ºä¹³å®¤ï¼ŒçœŸå¯¦ä¸²æ¥å°åŒ—å¸‚æ”¿åºœ API æ ¼å¼
            // let apiURL = `https://data.taipei/api/v1/dataset/...`; 
            
            // æ¨¡æ“¬è§£æå¾Œçš„çœŸå¯¦é»ä½æ¸²æŸ“
            const markers = (type === 'events') ? [
                { lat: 25.0315, lng: 121.5350, name: "å¤§å®‰æ£®æ—å…¬åœ’ï¼šè¦ªå­é‡é¤æ—¥", time: "14:00 - 17:00" },
                { lat: 25.0350, lng: 121.5650, name: "ä¿¡ç¾©å€ï¼šå…’ç«¥è—è¡“å·¥ä½œåŠ", time: "10:00 - 12:00" }
            ] : [
                { lat: 25.0339, lng: 121.5644, name: "101 è³¼ç‰©ä¸­å¿ƒå“ºä¹³å®¤", info: "4F" }
            ];

            markers.forEach(m => {
                const color = (type === 'events') ? '#FFBF00' : '#E91E63';
                const circle = L.circleMarker([m.lat, m.lng], {
                    radius: 10, fillColor: color, color: 'white', weight: 2, fillOpacity: 0.9
                }).addTo(dataLayer);

                circle.on('click', () => {
                    document.getElementById('current-location-name').innerText = m.name;
                    document.getElementById('dynamic-content').innerText = m.time || m.info;
                    map.panTo([m.lat, m.lng]);
                });
            });
        }

        // ğŸŸ¢ 4. ç’°å¢ƒè³‡è¨ŠåŒæ­¥ (å¤©æ°£èˆ‡åœ°å)
        async function updateUIInfo(lat, lng, defaultName) {
            // ä»‹æ¥ Open-Meteo å¤©æ°£
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
            const wData = await wRes.json();
            document.getElementById('weather-data').innerHTML = `ğŸŒ¡ï¸ ${Math.round(wData.current_weather.temperature)}Â°C<br><span style="color:#4CAF50;">â— AQI å„ªè‰¯</span>`;
            
            if(!defaultName) {
                const rRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const rData = await rRes.json();
                document.getElementById('current-location-name').innerText = rData.address.city || rData.address.suburb || "æ¢ç´¢ä¸­";
            } else {
                document.getElementById('current-location-name').innerText = defaultName.split(',')[0];
            }
        }

        map.on('moveend', () => {
            const c = map.getCenter();
            updateUIInfo(c.lat, c.lng);
        });

        // åˆå§‹åŒ–
        updateUIInfo(25.0339, 121.5644);
        fetchRealData('events');
    </script>
</body>
</html>

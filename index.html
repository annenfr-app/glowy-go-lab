<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy GO !</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; overflow: hidden; touch-action: none; }
        #map { height: 100vh; width: 100vw; background: #f0f0f0; }
        .user-dot { width: 18px; height: 18px; background: #3B82F6; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        .facility-dot { width: 12px; height: 12px; background: #FFBF00; border: 2px solid white; border-radius: 50%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="fixed top-4 left-0 right-0 z-[1000] px-4 flex items-center gap-3">
        <div class="flex-grow bg-white/95 backdrop-blur h-12 rounded-full shadow-lg flex items-center px-4 gap-3 border border-gray-100">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"></path></svg>
            <span class="text-gray-400 text-sm font-medium">æœå°‹æ´»å‹•æˆ–å‹å–„è¨­æ–½...</span>
        </div>
        <div class="w-12 h-12 bg-white rounded-full shadow-lg border-2 border-amber-200 flex items-center justify-center overflow-hidden">
            <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Glowy" class="w-full h-full object-cover">
        </div>
    </div>

    <div class="fixed top-20 left-0 right-0 z-[1000] flex gap-2 px-4 overflow-x-auto no-scrollbar">
        <button onclick="updateData('baby_care')" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸ¼ å“ºä¹³å®¤</button>
        <button onclick="updateData('toilets')" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸš¾ å…¬å»</button>
    </div>

    <button id="locate-btn" class="fixed right-6 top-36 z-[1000] w-12 h-12 bg-white rounded-full shadow-2xl flex items-center justify-center text-gray-700 active:text-amber-500 border border-gray-100" onclick="handlePermissionAndLocate()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
    </button>

    <div id="map"></div>

    <div class="fixed bottom-0 left-0 right-0 z-[2000] bg-white rounded-t-[32px] shadow-[0_-10px_30px_rgba(0,0,0,0.1)] px-8 pt-4 pb-10">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center">
            <div class="flex flex-col items-center gap-1"><div class="p-3 bg-amber-400 text-white rounded-2xl">ğŸ§­</div><span class="text-xs font-bold">æ¢ç´¢</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale text-2xl">ğŸ›’<span class="text-[10px]">æ”¯æ´</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale text-2xl">ğŸ”§<span class="text-[10px]">è²¢ç»</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.033, 121.565], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let facilityLayer = L.layerGroup().addTo(map);
        let userMarker = null;

        // ã€è«‹æ±‚æˆæ¬Šæ¨¡å¼ã€‘ç¬¦åˆæ­ç›Ÿè¦ç¯„çš„è™•ç†æµç¨‹
        async function handlePermissionAndLocate() {
            // 1. æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ç‹€æ…‹
            if (!navigator.geolocation) {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
                return;
            }

            try {
                // éƒ¨åˆ†ç€è¦½å™¨æ”¯æ´æŸ¥è©¢æ¬Šé™ç‹€æ…‹
                if (navigator.permissions && navigator.permissions.query) {
                    const result = await navigator.permissions.query({ name: 'geolocation' });
                    if (result.state === 'denied') {
                        alert("å®šä½æ¬Šé™å·²è¢«æ‹’çµ•ã€‚è«‹è‡³ç€è¦½å™¨è¨­å®šä¸­æ‰‹å‹•é–‹å•Ÿ Glowy GO ! çš„ä½ç½®å­˜å–æ¬Šé™ã€‚");
                        return;
                    }
                }
                
                // 2. åŸ·è¡Œå®šä½
                startLocating();
            } catch (error) {
                // å¦‚æœæŸ¥è©¢æ¬Šé™å‡ºéŒ¯ï¼Œç›´æ¥å˜—è©¦å®šä½
                startLocating();
            }
        }

        function startLocating() {
            map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: true });
        }

        map.on('locationfound', function(e) {
            console.log("å®šä½æˆåŠŸ:", e.latlng);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'user-dot', iconSize: [18, 18] }) }).addTo(map);
            map.flyTo(e.latlng, 16);
            updateData('baby_care'); // è‡ªå‹•è¼‰å…¥è³‡æ–™
        });

        map.on('locationerror', function(e) {
            alert("å®šä½å¤±æ•—ï¼š" + e.message + "\nè«‹ç¢ºä¿å·²é–‹å•Ÿæ‰‹æ©Ÿ GPS ä¸¦åœ¨å½ˆå‡ºè¦–çª—é»æ“Šã€Œå…è¨±ã€ã€‚");
        });

        async function updateData(type) {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const bbox = `${sw.lat},${sw.lng},${ne.lat},${ne.lng}`;

            let queryTag = 'nwr["amenity"~"baby_hatch|changing_room"];';
            if(type === 'toilets') queryTag = 'nwr["amenity"="toilets"];';

            const query = `[out:json][timeout:25];(${queryTag});out center(${bbox});`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                facilityLayer.clearLayers();
                data.elements.forEach(el => {
                    const lat = el.lat || (el.center && el.center.lat);
                    const lon = el.lon || (el.center && el.center.lon);
                    if (lat && lon) {
                        L.marker([lat, lon], { icon: L.divIcon({ className: 'facility-dot', iconSize: [12, 12] }) }).addTo(facilityLayer);
                    }
                });
            } catch (err) { console.error("è³‡æ–™åŠ è¼‰å¤±æ•—"); }
        }

        // é é¢åŠ è¼‰å¾Œç›´æ¥å˜—è©¦å•Ÿå‹•æˆæ¬Šæª¢æŸ¥
        window.onload = handlePermissionAndLocate;
    </script>
</body>
</html>

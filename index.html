<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy GO ! | è‚²å…’å‹å–„åœ°åœ–</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; overflow: hidden; touch-action: manipulation; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #e5e7eb; }
        .bg-amber-primary { background-color: #FFBF00; }
        
        /* UI å…ƒä»¶æ¨£å¼ */
        .leaflet-control-zoom { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ç¥ç€æ´»å‹•é» */
        .amber-dot {
            width: 22px; height: 22px;
            background: #FFBF00;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255,191,0,0.7);
        }
        /* é€æ˜å°é»ƒé» (OSM è¨­æ–½) */
        .facility-dot {
            width: 10px; height: 10px;
            background: rgba(255, 191, 0, 0.4);
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="fixed top-4 left-0 right-0 z-[1000] px-4 flex items-center gap-3">
        <div class="flex-grow bg-white/95 backdrop-blur h-12 rounded-full shadow-lg flex items-center px-4 gap-3 border border-gray-100 transition-transform active:scale-95" onclick="triggerSearch()">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <span class="text-gray-400 text-sm font-medium">æœå°‹æ´»å‹•æˆ–åœ°é»...</span>
        </div>
        <div class="w-12 h-12 bg-white rounded-full shadow-lg border-2 border-amber-200 flex items-center justify-center overflow-hidden" onclick="openMember()">
            <img id="avatar-img" src="" class="w-full h-full object-cover">
        </div>
    </div>

    <div class="fixed top-20 left-0 right-0 z-[1000] flex gap-2 px-4 overflow-x-auto no-scrollbar">
        <button onclick="toggleFacility('baby_care')" id="btn-baby_care" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border border-transparent active:bg-amber-50">ğŸ¼ å“ºä¹³å®¤</button>
        <button onclick="toggleFacility('toilets')" id="btn-toilets" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border border-transparent active:bg-amber-50">ğŸš¾ å…¬å»</button>
        <button onclick="toggleFacility('drinking_water')" id="btn-drinking_water" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border border-transparent active:bg-amber-50">ğŸ’§ é£²æ°´æ©Ÿ</button>
    </div>

    <button class="fixed right-6 top-36 z-[1000] w-12 h-12 bg-white rounded-full shadow-2xl flex items-center justify-center text-gray-700 active:text-amber-500 transition-all border border-gray-100" onclick="requestLocation()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>

    <div id="map"></div>

    <div class="fixed bottom-0 left-0 right-0 z-[2000] bg-white rounded-t-[32px] shadow-[0_-10px_40px_rgba(0,0,0,0.12)] px-8 pt-4 pb-10 border-t border-gray-50">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center text-center">
            <div class="flex flex-col items-center gap-1"><div class="p-3 bg-amber-400 text-white rounded-2xl shadow-lg shadow-amber-100 mb-1">ğŸ§­</div><span class="text-xs font-bold text-gray-900">æ¢ç´¢</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30"><div class="p-3 mb-1 text-2xl">ğŸ›’</div><span class="text-xs font-bold">å‘¨é‚Šæ”¯æ´</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30"><div class="p-3 mb-1 text-2xl">ğŸ”§</div><span class="text-xs font-bold">è²¢ç»</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30"><div class="p-3 mb-1 text-2xl">ğŸ§§</div><span class="text-xs font-bold">å…¶ä»–</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°åœ– (é è¨­ä¸€å€‹ç·©è¡åœ°é»ï¼Œç›´åˆ°ç²å¾— GPS)
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.033, 121.565], 16);
        
        // å…è²»åœ–è³‡ä¾†æºï¼šCartoDB Positron (ä¹¾æ·¨ã€é«˜æ•ˆ)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        let facilityLayers = L.layerGroup().addTo(map);
        let userMarker;
        let lastLoadPos = null;

        // éš¨æ©Ÿè²¼åœ–åˆå§‹åŒ– (ç¬¦åˆ GDPRï¼šæœªç¶“æˆæ¬Šä¸å­˜å–å€‹äººç…§ç‰‡)
        const seeds = ['Oliver', 'Milo', 'Luna', 'Kiki'];
        document.getElementById('avatar-img').src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seeds[Math.floor(Math.random()*4)]}`;

        // 1. GPS å®šä½è«‹æ±‚ (ä¾æ“šæ­ç›Ÿè¦å®šæ˜ç¢ºæç¤º)
        function requestLocation() {
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }

        map.on('locationfound', (e) => {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, { radius: 8, color: '#3B82F6', fillColor: '#3B82F6', fillOpacity: 0.8, weight: 3 }).addTo(map);
            
            // æ•ˆèƒ½å„ªåŒ–ï¼šç§»å‹•è¶…é 500 å…¬å°ºæ‰é‡æ–°è¼‰å…¥è³‡æ–™
            if (!lastLoadPos || e.latlng.distanceTo(lastLoadPos) > 500) {
                lastLoadPos = e.latlng;
                fetchOpenData('baby_care'); // é è¨­åŠ è¼‰å“ºä¹³å®¤
            }
        });

        // 2. ä»‹æ¥å…¨çƒ Overpass API (å…è²»ã€å… Key)
        async function fetchOpenData(type) {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            
            // å»ºç«‹ Overpass æŸ¥è©¢æŒ‡ä»¤
            let tag = "";
            if (type === 'baby_care') tag = 'node["amenity"="baby_hatch"]';
            if (type === 'toilets') tag = 'node["amenity"="toilets"]';
            if (type === 'drinking_water') tag = 'node["amenity"="drinking_water"]';

            const query = `[out:json][timeout:25];(${tag}(${sw.lat},${sw.lng},${ne.lat},${ne.lng}););out body;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                facilityLayers.clearLayers();
                
                data.elements.forEach(el => {
                    L.marker([el.lat, el.lon], {
                        icon: L.divIcon({ className: 'facility-dot', iconSize: [10, 10] })
                    }).bindPopup(`<div class="text-sm font-bold">${type === 'baby_care' ? 'ğŸ¼ è‚²å¬°è¨­æ–½' : 'ğŸ“ å‹å–„è¨­æ–½'}</div>`).addTo(facilityLayers);
                });
            } catch (err) {
                console.error("åœ–è³‡åŠ è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        // 3. å»¶å¾Œæˆæ¬Šï¼šé»æ“Šã€Œæ¡é›†ã€æ‰è«‹æ±‚ç›¸æ©Ÿ
        function triggerCapture() {
            if (confirm("Glowy GO ! è«‹æ±‚ä½¿ç”¨æ‚¨çš„ç›¸æ©Ÿä»¥ç´€éŒ„ã€ç”Ÿå‘½å²æ„Ÿã€å¯¶ç‰©ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ")) {
                alert("å·²ç²å–ç›¸æ©Ÿæ¬Šé™ï¼Œå•Ÿå‹•ç›¸æ©Ÿä»‹é¢...");
                // æ­¤è™•å¾ŒçºŒå°æ¥ WebRTC Camera API
            }
        }

        // æ¨™ç±¤åˆ‡æ›æ•ˆæœ
        function toggleFacility(type) {
            document.querySelectorAll('[id^="btn-"]').forEach(b => b.classList.remove('border-amber-400', 'bg-amber-50'));
            document.getElementById(`btn-${type}`).classList.add('border-amber-400', 'bg-amber-50');
            fetchOpenData(type);
        }

        function triggerSearch() { alert("é€²å…¥ SNCF æ¬¡é ç¯©é¸ï¼šå€åŸŸã€æ—¥æœŸã€å¯¶å¯¶åå–®"); }
        function openMember() { alert("é€²å…¥æœƒå“¡ï¼šç”Ÿå‘½å²æ„Ÿå›æ†¶éŒ„ã€ç¥ç€é»æ•¸éŒ¢åŒ…"); }

        // åˆæ¬¡åŠ è¼‰åŸ·è¡Œå®šä½è«‹æ±‚
        window.onload = requestLocation;
    </script>
</body>
</html>

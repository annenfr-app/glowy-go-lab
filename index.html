<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy GO ! | ç´€éŒ„å­©å­çš„ç”Ÿå‘½å°è¨˜</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; overflow: hidden; touch-action: manipulation; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #f8f9fa; }
        
        /* ä½¿ç”¨è€…ä½ç½® (è—é») */
        .user-dot { width: 18px; height: 18px; background: #3B82F6; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(59,130,246,0.6); }
        
        /* è¨­æ–½é» (é€æ˜å°é»ƒé») */
        .facility-dot { width: 12px; height: 12px; background: rgba(255, 191, 0, 0.6); border: 2px solid white; border-radius: 50%; pointer-events: none; }
        
        /* ç¥ç€è‰²æ´»å‹•é» (å¯¶ç‰© - å¸¶æœ‰å‘¼å¸å‹•ç•«) */
        .event-marker {
            position: relative; width: 30px; height: 30px;
            background: #FFBF00; border: 3px solid white; border-radius: 50%;
            display: flex; items-center; justify-center; font-size: 14px;
            box-shadow: 0 0 15px rgba(255,191,0,0.8);
        }
        .event-marker::after {
            content: ''; position: absolute; width: 100%; height: 100%;
            border-radius: 50%; background: #FFBF00; opacity: 0.4;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        #search-this-area {
            position: fixed; top: 140px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: none;
            background: white; padding: 10px 24px; border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-weight: bold; color: #333;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div class="fixed top-4 left-0 right-0 z-[1000] px-4 flex items-center gap-3">
        <div class="flex-grow bg-white/95 backdrop-blur h-12 rounded-full shadow-lg flex items-center px-4 gap-3 border border-gray-100 shadow-amber-100/50">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"></path></svg>
            <span class="text-gray-400 text-sm font-medium">è¦å»å“ªè£¡æ¡é›†ç”Ÿå‘½å²ï¼Ÿ</span>
        </div>
        <div class="w-12 h-12 bg-white rounded-full shadow-lg border-2 border-amber-200 flex items-center justify-center overflow-hidden">
            <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky" class="w-full h-full object-cover">
        </div>
    </div>

    <div class="fixed top-20 left-0 right-0 z-[1000] flex gap-2 px-4 overflow-x-auto no-scrollbar">
        <button onclick="changeType('baby_care')" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸ¼ å“ºä¹³å®¤</button>
        <button onclick="changeType('toilets')" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸš¾ å…¬å»</button>
        <button onclick="changeType('drinking_water')" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸ’§ é£²æ°´æ©Ÿ</button>
    </div>

    <button id="search-this-area" onclick="updateData()">ğŸ”„ æœå°‹æ­¤å€åŸŸè¨­æ–½</button>

    <button class="fixed right-6 top-36 z-[1000] w-12 h-12 bg-white rounded-full shadow-xl flex items-center justify-center text-blue-500 border border-gray-100 active:scale-90 transition-all" onclick="handlePermissionAndLocate()">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
    </button>

    <div id="map"></div>

    <div id="main-drawer" class="fixed bottom-0 left-0 right-0 z-[2000] bg-white rounded-t-[32px] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] px-8 pt-4 pb-10 transition-transform duration-300">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div id="drawer-content" class="flex justify-between items-center text-center">
            <div class="flex flex-col items-center gap-1"><div class="p-3 bg-amber-400 text-white rounded-2xl shadow-lg">ğŸ§­</div><span class="text-xs font-bold">æ¢ç´¢</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale"><div class="p-3 text-2xl">ğŸ›’</div><span class="text-xs font-bold">æ”¯æ´</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale"><div class="p-3 text-2xl">ğŸ”§</div><span class="text-xs font-bold">è²¢ç»</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale"><div class="p-3 text-2xl">ğŸ§§</div><span class="text-xs font-bold">å…¶ä»–</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°åœ– (é è¨­å·´é»)
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.8566, 2.3522], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let facilityLayer = L.layerGroup().addTo(map);
        let eventLayer = L.layerGroup().addTo(map);
        let userMarker = null;
        let currentType = 'baby_care';

        // æ¨¡æ“¬å¯¶ç‰©æ´»å‹•è³‡æ–™
        const mockEvents = [
            { id: 1, name: "ğŸ¨ ç¾…æµ®å®®è¦ªå­è—è¡“å­£", lat: 48.8606, lon: 2.3376, desc: "åœ¨ç¾…æµ®å®®æ¡é›†ç¬¬ä¸€ç‰‡è—è¡“å²ç¢ç‰‡" },
            { id: 2, name: "ğŸˆ æœæ¨‚éº—èŠ±åœ’å˜‰å¹´è¯", lat: 48.8635, lon: 2.3275, desc: "åˆ»ç•«èˆ‡å­©å­åœ¨æ—‹è½‰æœ¨é¦¬ä¸Šçš„å°è¨˜" },
            { id: 3, name: "ğŸ¥ æ³•å¼å°å»šå¸«å·¥ä½œåŠ", lat: 48.8525, lon: 2.3471, desc: "ç´€éŒ„å­©å­ç¬¬ä¸€æ¬¡æ‰‹ä½œç¾é£Ÿçš„æ„Ÿå‹•" }
        ];

        // æ ¸å¿ƒå®šä½å‡½å¼
        async function handlePermissionAndLocate() {
            map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: true, maximumAge: 0 });
        }

        map.on('locationfound', (e) => {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'user-dot', iconSize: [18, 18] }) }).addTo(map);
            updateData(); 
        });

        map.on('moveend', () => { document.getElementById('search-this-area').style.display = 'block'; });

        function changeType(type) {
            currentType = type;
            updateData();
        }

        // æŠ“å–è¨­æ–½ (é…è§’)
        async function updateData() {
            document.getElementById('search-this-area').style.display = 'none';
            const b = map.getBounds();
            const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
            
            let tag = `nwr["amenity"~"baby_care|changing_room|baby_hatch"](${bbox});nwr["changing_table"="yes"](${bbox});`;
            if(currentType === 'toilets') tag = `nwr["amenity"="toilets"](${bbox});`;
            if(currentType === 'drinking_water') tag = `nwr["amenity"="drinking_water"](${bbox});`;

            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];(${tag});out center;`);
                const data = await res.json();
                facilityLayer.clearLayers();
                data.elements.forEach(el => {
                    const lat = el.lat || el.center.lat;
                    const lon = el.lon || el.center.lon;
                    L.circleMarker([lat, lon], { radius: 6, fillColor: "#FFBF00", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.6 }).addTo(facilityLayer);
                });
            } catch (err) { console.log("åœ–è³‡è«‹æ±‚ç¨å¿«"); }
        }

        // æ¸²æŸ“æ´»å‹•å¯¶ç‰© (ä¸»è§’)
        function renderEvents() {
            eventLayer.clearLayers();
            const eventIcon = L.divIcon({
                className: '',
                html: `<div class="event-marker">âœ¨</div>`,
                iconSize: [30, 30]
            });

            mockEvents.forEach(evt => {
                L.marker([evt.lat, evt.lon], { icon: eventIcon }).addTo(eventLayer).on('click', () => showEventDrawer(evt));
            });
        }

        // å‡èµ·ç”Ÿå‘½å²æ¡é›†æŠ½å±œ
        function showEventDrawer(evt) {
            const content = `
                <div class="animate-slide-up">
                    <div class="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-6"></div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-amber-100 text-amber-600 text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider">Life History +1</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">${evt.name}</h2>
                    <p class="text-gray-500 mt-2 text-sm leading-relaxed">${evt.desc}</p>
                    <div class="mt-8 flex gap-3">
                        <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${evt.lat},${evt.lon}')" class="flex-1 border-2 border-amber-400 text-amber-600 py-4 rounded-2xl font-bold active:bg-amber-50 transition-colors">ğŸ—ºï¸ å°èˆªå‰å¾€</button>
                        <button onclick="recordLife()" class="flex-[1.5] bg-amber-400 text-white py-4 rounded-2xl font-bold shadow-lg shadow-amber-200 active:scale-95 transition-all">ğŸ“¸ ç´€éŒ„é€™æ®µç”Ÿå‘½å²</button>
                    </div>
                    <p class="text-center text-gray-400 text-[10px] mt-6 italic">ã€Œé€™ä¸æ˜¯é»æ•¸ï¼Œæ˜¯æ‚¨èˆ‡å­©å­ç¨ä¸€ç„¡äºŒçš„å›æ†¶ã€</p>
                </div>
            `;
            document.getElementById('drawer-content').innerHTML = content;
            map.flyTo([evt.lat, evt.lon], 16);
        }

        function recordLife() {
            alert("âœ¨ ç”Ÿå‘½å²å·²ç´€éŒ„ï¼\nç…§ç‰‡èˆ‡å›æ†¶å·²å­˜å…¥æ‚¨çš„å€‹äººå¡åŒ…ã€‚");
            location.reload(); // æš«æ™‚é‡æ•´å›é¦–é 
        }

        window.onload = () => {
            handlePermissionAndLocate();
            renderEvents();
        };
    </script>
</body>
</html>

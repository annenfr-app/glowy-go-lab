<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Glowy GO ! 全球語系版</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fdfaf5; font-family: -apple-system, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .gmap-dot {
            background-color: #FFBF00 !important; border: 1px solid #FFFFFF !important;
            border-radius: 50% !important; width: 8px !important; height: 8px !important;
            display: block !important; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .filter-panel {
            position: absolute; top: 15px; left: 0; right: 0; z-index: 1000;
            display: flex; flex-wrap: wrap; gap: 6px; padding: 0 15px; justify-content: center;
        }
        .filter-btn {
            background: rgba(255,255,255,0.95); padding: 8px 16px; border-radius: 20px; font-size: 13px;
            border: 1px solid #FFBF00; color: #D28E5D; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .filter-btn.active { background: #FFBF00; color: white; }
        #status-bar {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.7); color: white; padding: 8px 20px; border-radius: 30px; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="filter-panel" class="filter-panel"></div>
    <div id="status-bar">Detecting Language...</div>
    <div id="map"></div>

    <script>
        // --- 翻譯字典架構 ---
        const i18n = {
            'zh': { 'changing_table': '尿布台', 'toilets': '公共廁所', 'baby_feeding': '哺乳室', 'loading': '偵測中...', 'found': '已點亮 {n} 個琥珀空間' },
            'fr': { 'changing_table': 'Table à langer', 'toilets': 'Toilettes', 'baby_feeding': 'Allaitement', 'loading': 'Détection...', 'found': '{n} points ambre' },
            'en': { 'changing_table': 'Changing Table', 'toilets': 'Toilets', 'baby_feeding': 'Baby Feeding', 'loading': 'Scanning...', 'found': '{n} Amber Spots' }
        };

        // 自動偵測語系 (取前兩個字，如 zh-TW -> zh)
        const userLang = (navigator.language || navigator.userLanguage).substring(0, 2);
        const lang = i18n[userLang] || i18n['en']; // 預設英文

        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.8566, 2.3522], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        var amberIcon = L.divIcon({ className: 'none', html: '<div class="gmap-dot"></div>', iconSize: [8, 8], iconAnchor: [4, 4] });
        var markerLayer = L.layerGroup().addTo(map);
        var allElements = [];
        var activeFilters = new Set();

        async function fetchData() {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            
            const query = `[out:json];(
                node["changing_table"](${sw.lat},${sw.lng},${ne.lat},${ne.lng});
                node["amenity"="toilets"](${sw.lat},${sw.lng},${ne.lat},${ne.lng});
                node["baby_feeding"](${sw.lat},${sw.lng},${ne.lat},${ne.lng});
            );out body;`;
            
            document.getElementById('status-bar').innerText = lang.loading;
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                allElements = data.elements;
                updateFilterUI();
                renderMarkers();
            } catch (e) { console.error(e); }
        }

        function updateFilterUI() {
            const panel = document.getElementById('filter-panel');
            const availableKeys = new Set();
            
            allElements.forEach(el => {
                if (el.tags.changing_table) availableKeys.add('changing_table');
                if (el.tags.amenity === 'toilets') availableKeys.add('toilets');
                if (el.tags.baby_feeding) availableKeys.add('baby_feeding');
            });

            panel.innerHTML = '';
            availableKeys.forEach(key => {
                const btn = document.createElement('div');
                const label = lang[key] || key;
                btn.className = 'filter-btn' + (activeFilters.has(key) || activeFilters.size === 0 ? ' active' : '');
                btn.innerText = label;
                btn.onclick = () => {
                    if (activeFilters.has(key)) activeFilters.delete(key);
                    else activeFilters.add(key);
                    updateFilterUI();
                    renderMarkers();
                };
                panel.appendChild(btn);
            });
        }

        function renderMarkers() {
            markerLayer.clearLayers();
            let count = 0;
            allElements.forEach(el => {
                let key = el.tags.changing_table ? 'changing_table' : 
                          (el.tags.amenity === 'toilets' ? 'toilets' : 'baby_feeding');
                
                if (activeFilters.size === 0 || activeFilters.has(key)) {
                    const name = el.tags.name || lang[key] || "Spot";
                    L.marker([el.lat, el.lon], { icon: amberIcon })
                     .bindPopup(`<b>${name}</b><br>${lang[key]}`)
                     .addTo(markerLayer);
                    count++;
                }
            });
            document.getElementById('status-bar').innerText = lang.found.replace('{n}', count);
        }

        map.on('moveend', fetchData);
        map.locate({setView: true, maxZoom: 15});
        fetchData();
    </script>
</body>
</html>

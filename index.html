<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy GO !</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; background: #f8f9fa; }
        .user-dot { width: 18px; height: 18px; background: #3B82F6; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(59,130,246,0.6); }
        .facility-dot { width: 12px; height: 12px; background: rgba(255, 191, 0, 0.7); border: 2px solid white; border-radius: 50%; pointer-events: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æœå°‹æ­¤å€åŸŸæŒ‰éˆ•æ¨£å¼ */
        #search-this-area {
            position: fixed; top: 140px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: none;
            background: white; padding: 8px 20px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-weight: bold; font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="fixed top-4 left-0 right-0 z-[1000] px-4 flex items-center gap-3">
        <div class="flex-grow bg-white/95 backdrop-blur h-12 rounded-full shadow-lg flex items-center px-4 gap-3 border border-gray-100">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"></path></svg>
            <span class="text-gray-400 text-sm">è¦å»å“ªè£¡ç©ï¼Ÿ(å·´é»ã€å°åŒ—...)</span>
        </div>
        <div class="w-12 h-12 bg-white rounded-full shadow-lg border-2 border-amber-200 flex items-center justify-center overflow-hidden">
            <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky" class="w-full h-full">
        </div>
    </div>

    <div class="fixed top-20 left-0 right-0 z-[1000] flex gap-2 px-4 overflow-x-auto no-scrollbar">
        <button onclick="currentType='baby_care'; updateData();" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸ¼ å“ºä¹³å®¤</button>
        <button onclick="currentType='toilets'; updateData();" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸš¾ å…¬å»</button>
        <button onclick="currentType='drinking_water'; updateData();" class="flex-shrink-0 px-5 py-2 bg-white rounded-full shadow-md text-xs font-bold border active:bg-amber-50">ğŸ’§ é£²æ°´æ©Ÿ</button>
    </div>

    <button id="search-this-area" onclick="updateData()">
        ğŸ”„ æœå°‹æ­¤å€åŸŸçš„è¨­æ–½
    </button>

    <button class="fixed right-6 top-36 z-[1000] w-12 h-12 bg-white rounded-full shadow-xl flex items-center justify-center text-blue-500 border" onclick="locateUser()">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
    </button>

    <div id="map"></div>

    <div class="fixed bottom-0 left-0 right-0 z-[2000] bg-white rounded-t-[32px] shadow-[0_-10px -30px_rgba(0,0,0,0.1)] px-8 pt-4 pb-10">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center text-center">
            <div class="flex flex-col items-center gap-1"><div class="p-3 bg-amber-400 text-white rounded-2xl shadow-lg">ğŸ§­</div><span class="text-xs font-bold">æ¢ç´¢</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale text-2xl">ğŸ›’<span class="text-[10px]">æ”¯æ´</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale text-2xl">ğŸ”§<span class="text-[10px]">è²¢ç»</span></div>
            <div class="flex flex-col items-center gap-1 opacity-30 grayscale text-2xl">ğŸ§§<span class="text-[10px]">å…¶ä»–</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // 1. åˆå§‹åŒ–åœ°åœ–ï¼šé è¨­ä¸­å¿ƒé»è¨­åœ¨å·´é» (ä½ ç›®å‰æ‰€åœ¨åœ°)
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.8566, 2.3522], 13);
    
    // ä½¿ç”¨å…è²»ä¸”å¿«é€Ÿçš„åœ–è³‡ä¾†æº
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    let facilityLayer = L.layerGroup().addTo(map);
    let userMarker = null;
    let currentType = 'baby_care'; // é è¨­é¡¯ç¤ºå“ºä¹³å®¤

    // 2. åµæ¸¬ä½¿ç”¨è€…ç§»å‹•åœ°åœ–ï¼šé¡¯ç¤ºã€Œæœå°‹æ­¤å€åŸŸã€æŒ‰éˆ•
    map.on('moveend', () => {
        document.getElementById('search-this-area').style.display = 'block';
    });

    // 3. æ ¸å¿ƒå®šä½å‡½å¼ï¼šå¼·åˆ¶é–‹å•Ÿæœ€é«˜ç²¾ç¢ºåº¦
    function locateUser() {
        map.locate({ 
            setView: true, 
            maxZoom: 16, 
            enableHighAccuracy: true, // å¼·åˆ¶ä½¿ç”¨ GPS æ™¶ç‰‡ï¼Œæå‡æº–ç¢ºåº¦
            maximumAge: 0             // ä¸ä½¿ç”¨èˆŠçš„ç·©å­˜åº§æ¨™
        });
    }

    // å®šä½æˆåŠŸå›å‚³è™•ç†
    map.on('locationfound', (e) => {
        console.log("GPS å®šä½æˆåŠŸ");
        if (userMarker) map.removeLayer(userMarker);
        
        // å»ºç«‹è—é» (ä½¿ç”¨è€…ä½ç½®)
        userMarker = L.marker(e.latlng, { 
            icon: L.divIcon({ className: 'user-dot', iconSize: [18, 18] }) 
        }).addTo(map);
        
        map.flyTo(e.latlng, 16); // é£›å‘å®šä½é»
        updateData();            // å®šä½æˆåŠŸå¾Œè‡ªå‹•æŠ“å–é™„è¿‘è¨­æ–½
    });

    // å®šä½å¤±æ•—å›å‚³è™•ç†
    map.on('locationerror', () => {
        alert("å®šä½å¤±æ•—ï¼è«‹é»æ“Šç¶²å€åˆ—å·¦å´åœ–ç¤ºï¼Œç¢ºèªã€Œä½ç½®è³‡è¨Šã€æ¬Šé™å·²æ”¹ç‚ºã€Œå…è¨±ã€ã€‚");
    });

    // 4. æŠ“å–å…¨çƒ OpenData è¨­æ–½è³‡æ–™ (Overpass API)
    async function updateData(type) {
        if(type) currentType = type; // å¦‚æœæœ‰å‚³å…¥é¡å‹å‰‡æ›´æ–°
        
        // éš±è—ã€Œæœå°‹æ­¤å€ã€æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡é»æ“Š
        document.getElementById('search-this-area').style.display = 'none';
        
        const bounds = map.getBounds();
        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
        
        // é‡å°æ­æ´²åœ°å€å„ªåŒ–çš„æ¨™ç±¤æŸ¥è©¢
        let queryTag = '';
        if(currentType === 'baby_care') queryTag = `nwr["amenity"~"baby_care|changing_room|baby_hatch"](${bbox});nwr["changing_table"="yes"](${bbox});`;
        if(currentType === 'toilets') queryTag = `nwr["amenity"="toilets"](${bbox});`;
        if(currentType === 'drinking_water') queryTag = `nwr["amenity"="drinking_water"](${bbox});`;

        // ä½¿ç”¨å…¨çƒè² è¼‰å¹³è¡¡çš„ Overpass ä¼ºæœå™¨
        const url = `https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];(${queryTag});out center;`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            
            facilityLayer.clearLayers(); // æ¸…é™¤èˆŠæœ‰çš„é»ä½
            
            data.elements.forEach(el => {
                const lat = el.lat || (el.center && el.center.lat);
                const lon = el.lon || (el.center && el.center.lon);
                if (lat && lon) {
                    // ç¹ªè£½é€æ˜å°é»ƒé» (è¨­æ–½æ¨™è¨˜)
                    L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: "#FFBF00",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.6 // é€æ˜æ„Ÿ
                    }).addTo(facilityLayer);
                }
            });
            console.log(`æˆåŠŸè¼‰å…¥ ${data.elements.length} å€‹è¨­æ–½é»`);
        } catch (err) {
            console.error("åœ–è³‡æŠ“å–éæ–¼é »ç¹ï¼Œè«‹ç¨å€™å†è©¦");
        }
    }

    // 5. é é¢å•Ÿå‹•æ™‚è‡ªå‹•æª¢æŸ¥æˆæ¬Šä¸¦å®šä½
    window.onload = locateUser;
</script>

</body>
</html>

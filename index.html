<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Glowy GO ! æ™ºæ…§å®šä½å•Ÿå‹•ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fdfaf5; font-family: -apple-system, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .gmap-dot { background-color: #FFBF00; border: 2px solid #FFF; border-radius: 50%; width: 10px; height: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .radar-btn { position: absolute; bottom: 100px; right: 20px; z-index: 1000; background: #FFBF00; color: white; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #status-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(0,0,0,0.75); color: white; padding: 8px 20px; border-radius: 30px; font-size: 12px; white-space: nowrap; }
    </style>
</head>
<body>

    <button class="radar-btn" onclick="manualScan()">ğŸ“¡</button>
    <div id="status-bar">æº–å‚™ä¸­...</div>
    <div id="map"></div>

    <script>
        // è¨­å®šé è¨­èµ·å§‹é» (ä¾‹å¦‚å¤§ç¨»åŸ•)
        const defaultCenter = [25.056, 121.511];
        const map = L.map('map', { zoomControl: false, attributionControl: false, preferCanvas: true }).setView(defaultCenter, 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const amberIcon = L.divIcon({ className: 'none', html: '<div class="gmap-dot"></div>', iconSize: [10, 10] });
        const markerLayer = L.layerGroup().addTo(map);
        let userPos = null;

        // æ ¸å¿ƒèª¿é–±å‡½æ•¸
        async function fetchArea(lat, lng, rangeKm, msg) {
            document.getElementById('status-bar').innerText = msg;
            // 20km æ›ç®—ç´„ç‚º 0.18 ç¶“ç·¯åº¦ç¯„åœ
            const r = rangeKm / 111; 
            const query = `[out:json][timeout:20];node["changing_table"](${lat-r},${lng-r},${lat+r},${lng+r});out body 200;`;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                renderPoints(data.elements);
                document.getElementById('status-bar').innerText = `å·²è¼‰å…¥æ–¹åœ“ ${rangeKm}km å…§ ${data.elements.length} å€‹é»ä½`;
            } catch (e) {
                document.getElementById('status-bar').innerText = "è³‡æ–™åº«é€£ç·šä¸­ï¼Œè«‹ç¨å€™...";
            }
        }

        function renderPoints(elements) {
            elements.forEach(el => {
                L.marker([el.lat, el.lon], { icon: amberIcon }).bindPopup(`<b>${el.tags.name || 'ç¥ç€é»ä½'}</b>`).addTo(markerLayer);
            });
        }

        function manualScan() {
            const center = map.getCenter();
            fetchArea(center.lat, center.lng, 20, "æ·±åº¦æƒæ 20km...");
        }

        // å®šä½æˆåŠŸè™•ç†
        map.on('locationfound', (e) => {
            userPos = e.latlng;
            fetchArea(e.latlng.lat, e.latlng.lng, 20, "æ‰¾åˆ°æ‚¨äº†ï¼æ­£åœ¨è¼‰å…¥é€±é‚Š 20km...");
        });

        // å®šä½å¤±æ•—/æ‹’çµ•è™•ç†
        map.on('locationerror', () => {
            console.log("ç”¨æˆ¶æ‹’çµ•å®šä½ï¼Œæ”¹ç”¨é è¨­èµ·å§‹é»");
            fetchArea(defaultCenter[0], defaultCenter[1], 20, "æœªæˆæ¬Šå®šä½ï¼Œè¼‰å…¥èµ·å§‹é» 20km...");
        });

        // ä¸€é–‹å§‹å°±è©¢å•å®šä½
        map.locate({setView: true, maxZoom: 15});
        
        // å¦‚æœ 3 ç§’å¾Œæ²’åæ‡‰ (ç”¨æˆ¶é‚„åœ¨è€ƒæ…®æˆæ¬Š)ï¼Œå…ˆç”¨èµ·å§‹é»æƒæä¸€æ¬¡åšç‚ºå¢Šåº•
        setTimeout(() => {
            if (!userPos && markerLayer.getLayers().length === 0) {
                fetchArea(defaultCenter[0], defaultCenter[1], 20, "ç­‰å¾…å®šä½æˆæ¬Šï¼Œå…ˆç‚ºæ‚¨è¼‰å…¥æ¨è–¦å€åŸŸ...");
            }
        }, 3000);

    </script>
</body>
</html>

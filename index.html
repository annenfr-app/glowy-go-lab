<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy GO !</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #f8f9fa; }
        .bg-amber-primary { background-color: #FFBF00; }
        .leaflet-control-zoom { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ç¥ç€æ´»å‹•é» */
        .amber-dot {
            width: 20px; height: 20px;
            background: #FFBF00;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(255,191,0,0.8);
        }
        /* OpenData è¨­æ–½å°é»ƒé» */
        .facility-dot {
            width: 8px; height: 8px;
            background: rgba(255, 191, 0, 0.5);
            border-radius: 50%;
            border: 1px solid white;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="fixed top-4 left-0 right-0 z-[1000] px-4 flex items-center gap-3">
        <div class="flex-grow bg-white h-12 rounded-full shadow-lg flex items-center px-4 gap-3 cursor-pointer border border-gray-100" onclick="alert('SNCF æœå°‹æ¬¡é ')">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <span class="text-gray-400 text-sm font-medium">è¦å»å“ªè£¡ç©ï¼Ÿ</span>
        </div>
        <div class="w-12 h-12 bg-amber-50 rounded-full shadow-lg border-2 border-white flex items-center justify-center overflow-hidden">
            <img id="avatar-img" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Lucky" class="w-full h-full object-cover">
        </div>
    </div>

    <div class="fixed top-20 left-0 right-0 z-[1000] flex gap-2 px-4 overflow-x-auto no-scrollbar">
        <button onclick="fetchOpenData('baby_care')" class="flex-shrink-0 px-4 py-2 bg-white/90 backdrop-blur rounded-full shadow-sm text-xs font-bold border border-gray-200 active:bg-amber-100">ğŸ¼ å“ºä¹³å®¤</button>
        <button onclick="fetchOpenData('toilets')" class="flex-shrink-0 px-4 py-2 bg-white/90 backdrop-blur rounded-full shadow-sm text-xs font-bold border border-gray-200 active:bg-amber-100">ğŸš¾ å…¬å»</button>
        <button onclick="fetchOpenData('drinking_water')" class="flex-shrink-0 px-4 py-2 bg-white/90 backdrop-blur rounded-full shadow-sm text-xs font-bold border border-gray-200 active:bg-amber-100">ğŸ’§ é£²æ°´æ©Ÿ</button>
    </div>

    <button class="fixed right-6 top-36 z-[1000] w-12 h-12 bg-white rounded-full shadow-xl flex items-center justify-center text-gray-600 active:text-amber-500 transition-all" onclick="locateUser()">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </button>

    <div id="map"></div>

    <div class="fixed bottom-0 left-0 right-0 z-[2000] bg-white rounded-t-[32px] shadow-[0_-10px_30px_rgba(0,0,0,0.1)] px-8 pt-4 pb-10">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-center text-center">
            <div class="flex flex-col items-center gap-1"><div class="p-2 bg-amber-100 rounded-2xl text-amber-600 mb-1">ğŸ§­</div><span class="text-xs font-bold text-gray-800">æ¢ç´¢</span></div>
            <div class="flex flex-col items-center gap-1 opacity-40 grayscale"><div class="p-2 mb-1 text-xl">ğŸ›’</div><span class="text-xs font-bold">å‘¨é‚Šæ”¯æ´</span></div>
            <div class="flex flex-col items-center gap-1 opacity-40 grayscale"><div class="p-2 mb-1 text-xl">ğŸ”§</div><span class="text-xs font-bold">è²¢ç»</span></div>
            <div class="flex flex-col items-center gap-1 opacity-40 grayscale"><div class="p-2 mb-1 text-xl">ğŸ§§</div><span class="text-xs font-bold">å…¶ä»–</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°åœ–ï¼šé è¨­ä¸­å¿ƒé» (è‹¥æœªå®šä½)
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.0339, 121.5644], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        let facilityLayers = L.layerGroup().addTo(map);

        // A. å®šä½é‚è¼¯ï¼šå„ªå…ˆå˜—è©¦è‡ªå‹•å®šä½
        function locateUser() {
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }

        map.on('locationfound', (e) => {
            L.circle(e.latlng, {radius: 200, color: '#FFBF00', fillOpacity: 0.1}).addTo(map);
            // ç•¶å®šä½æˆåŠŸï¼Œè¼‰å…¥æ–¹åœ“ 10km å…§çš„ OpenData (æ­¤ API å»ºè­°ç”¨ç•¶å‰è¦–é‡ Bounding Box æ•ˆèƒ½æœ€ä½³)
            fetchOpenData('baby_care'); 
        });

        map.on('locationerror', () => {
            alert("è«‹é–‹å•Ÿ GPS å®šä½æˆæ¬Šï¼Œä»¥ç²å¾—æœ€ä½³è‚²å…’åœ°åœ–é«”é©—ï¼");
        });

        // B. å…¨çƒ OpenData ä»‹æ¥ (Overpass API)
        async function fetchOpenData(type) {
            facilityLayers.clearLayers();
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // æ ¹æ“šæ¨™ç±¤æ±ºå®š OSM æŸ¥è©¢èªå¥
            let queryTag = "";
            if(type === 'baby_care') queryTag = 'node["amenity"="baby_hatch"]'; // æˆ– "changing_table"
            if(type === 'toilets') queryTag = 'node["amenity"="toilets"]';
            if(type === 'drinking_water') queryTag = 'node["amenity"="drinking_water"]';

            const url = `https://overpass-api.de/api/interpreter?data=[out:json];${queryTag}(${bbox});out;`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                data.elements.forEach(el => {
                    L.marker([el.lat, el.lon], {
                        icon: L.divIcon({ className: 'facility-dot', iconSize: [8, 8] })
                    }).bindPopup(type).addTo(facilityLayers);
                });
            } catch (error) {
                console.error("OpenData è¼‰å…¥å¤±æ•—", error);
            }
        }

        // é é¢è¼‰å…¥å¾Œç«‹å³è«‹æ±‚å®šä½
        window.onload = () => {
            locateUser();
            const stickers = ['Lucky', 'Scooter', 'Mochi'];
            document.getElementById('avatar-img').src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${stickers[Math.floor(Math.random()*3)]}`;
        };
    </script>
</body>
</html>

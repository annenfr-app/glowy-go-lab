<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Glowy GO ! 10km Á≤æËèØÁâà</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fdfaf5; font-family: -apple-system, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .gmap-dot { background-color: #FFBF00; border: 2px solid #FFF; border-radius: 50%; width: 10px; height: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .radar-btn { 
            position: absolute; bottom: 30px; right: 20px; z-index: 1000; 
            background: #FFBF00; color: white; border: none; width: 56px; height: 56px; 
            border-radius: 50%; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        #data-count {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.85); color: #D28E5D; 
            padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;
        }
    </style>
</head>
<body>

    <button class="radar-btn" onclick="manualScan()">üì°</button>
    <div id="data-count">0</div>
    <div id="map"></div>

    <script>
        // Ëµ∑ÂßãÈªû (Â∑¥ÈªéÂ∫ßÊ®ôÔºåÊñπ‰æøÂ¶≥Âú®Áï∂Âú∞Ê∏¨Ë©¶)
        const startPos = [48.8566, 2.3522];
        const map = L.map('map', { zoomControl: false, attributionControl: false, preferCanvas: true }).setView(startPos, 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const amberIcon = L.divIcon({ className: 'none', html: '<div class="gmap-dot"></div>', iconSize: [10, 10] });
        const markerLayer = L.layerGroup().addTo(map);

        // ÂçäÂæë 10km Ë™øÈñ± (10km / 111km per degree ‚âà 0.09)
        async function loadData(lat, lng, radiusKm = 10) {
            const r = radiusKm / 111;
            const query = `[out:json][timeout:15];node["changing_table"](${lat-r},${lng-r},${lat+r},${lng+r});out body 150;`;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                
                data.elements.forEach(el => {
                    L.marker([el.lat, el.lon], { icon: amberIcon })
                     .bindPopup(`<b>${el.tags.name || 'Áê•ÁèÄÈªû‰Ωç'}</b>`)
                     .addTo(markerLayer);
                });
                document.getElementById('data-count').innerText = markerLayer.getLayers().length;
            } catch (e) { /* ÈùúÈªòËôïÁêÜÈåØË™§ */ }
        }

        function manualScan() {
            const center = map.getCenter();
            loadData(center.lat, center.lng, 10);
        }

        // ÂïüÂãïÁ≠ñÁï•
        map.locate({setView: true, maxZoom: 15});

        // Êê∂Ë∑ëÔºöÁ´ãÂàªÊäìËµ∑ÂßãÈªû 10km
        setTimeout(() => {
            if (markerLayer.getLayers().length === 0) {
                loadData(startPos[0], startPos[1], 10);
            }
        }, 100);

        // ÂÆö‰ΩçÊàêÂäüÂæåÔºåÂ¶ÇÊûúÂÅèÂ∑ÆÂ§ßÊñº 3km ÊâçË£úÊäì
        map.on('locationfound', (e) => {
            const dist = e.latlng.distanceTo(L.latLng(startPos));
            if (dist > 3000) {
                loadData(e.latlng.lat, e.latlng.lng, 10);
            }
        });
    </script>
</body>
</html>

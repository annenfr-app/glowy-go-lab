<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Glowy GO ! å¤šé¸ç¥ç€åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fdfaf5; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        .gmap-dot {
            background-color: #FFBF00 !important; border: 1px solid #FFFFFF !important;
            border-radius: 50% !important; width: 8px !important; height: 8px !important;
            display: block !important; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* è¤‡é¸æŒ‰éˆ•å€ */
        .filter-panel {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; flex-wrap: wrap; gap: 8px; width: 90%; justify-content: center;
        }
        
        .filter-btn {
            background: white; padding: 8px 16px; border-radius: 20px; font-size: 13px;
            border: 1.5px solid #FFBF00; color: #D28E5D; font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s;
        }

        /* é¸ä¸­ç‹€æ…‹çš„æŒ‰éˆ•æ¨£å¼ */
        .filter-btn.active {
            background: #FFBF00; color: white; border-color: #FFBF00;
        }

        #status {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.6); color: white;
            padding: 5px 15px; border-radius: 15px; font-size: 11px;
        }
    </style>
</head>
<body>

    <div class="filter-panel">
        <div class="filter-btn active" onclick="toggleFilter(this, 'gov')">ğŸ›ï¸ å…¬å®¶æ©Ÿé—œ</div>
        <div class="filter-btn active" onclick="toggleFilter(this, 'mall')">ğŸ›ï¸ ç™¾è²¨å…¬å¸</div>
        <div class="filter-btn active" onclick="toggleFilter(this, 'transport')">ğŸš‰ äº¤é€šè»Šç«™</div>
    </div>

    <div id="status">æ­£åœ¨åŒæ­¥å…¨åœ‹è³‡æ–™...</div>
    <div id="map"></div>

    <script>
        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.056, 121.511], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        var amberIcon = L.divIcon({ className: 'none', html: '<div class="gmap-dot"></div>', iconSize: [8, 8], iconAnchor: [4, 4] });
        
        var allSpots = []; // å„²å­˜æ‰€æœ‰åŸå§‹è³‡æ–™
        var activeFilters = ['gov', 'mall', 'transport']; // ç›®å‰é¸ä¸­çš„åˆ†é¡
        var markerLayer = L.layerGroup().addTo(map); // ç”¨ä¾†ç®¡ç†æ¨™è¨˜çš„åœ–å±¤

        // 1. ä¸‹è¼‰è³‡æ–™ä¸¦åˆ†é¡
        async function loadData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/kiang/nurseries/master/data.json');
                const data = await response.json();
                
                allSpots = data.features.map(f => {
                    // ç°¡æ˜“åˆ†é¡é‚è¼¯ (å¯¦éš›å¯æ ¹æ“šåç¨±é—œéµå­—æ›´ç²¾æº–åˆ†é¡)
                    let type = 'gov';
                    const name = f.properties.name;
                    if (name.includes('ç™¾è²¨') || name.includes('è³¼ç‰©') || name.includes('èª å“')) type = 'mall';
                    else if (name.includes('ç«™') || name.includes('æ·é‹') || name.includes('æ©Ÿå ´')) type = 'transport';
                    
                    return {
                        coords: [f.geometry.coordinates[1], f.geometry.coordinates[0]],
                        name: name,
                        address: f.properties.address,
                        type: type
                    };
                });
                renderMarkers();
            } catch (e) { document.getElementById('status').innerText = "è³‡æ–™åŠ è¼‰å¤±æ•—"; }
        }

        // 2. æ¸²æŸ“é‚è¼¯
        function renderMarkers() {
            markerLayer.clearLayers(); // å…ˆæ¸…ç©ºåœ°åœ–
            let visibleCount = 0;

            allSpots.forEach(spot => {
                if (activeFilters.includes(spot.type)) {
                    L.marker(spot.coords, { icon: amberIcon })
                     .bindPopup(`<b>${spot.name}</b><br>${spot.address}`)
                     .addTo(markerLayer);
                    visibleCount++;
                }
            });
            document.getElementById('status').innerText = `é¡¯ç¤ºä¸­ï¼š${visibleCount} è™•ç¥ç€ç©ºé–“`;
        }

        // 3. åˆ‡æ›éæ¿¾å™¨
        function toggleFilter(btn, type) {
            btn.classList.toggle('active');
            if (activeFilters.includes(type)) {
                activeFilters = activeFilters.filter(t => t !== type); // ç§»é™¤é¸ä¸­
            } else {
                activeFilters.push(type); // åŠ å…¥é¸ä¸­
            }
            renderMarkers(); // é‡æ–°ç•«åœ°åœ–
        }

        loadData();
        map.locate({setView: true, maxZoom: 15});
    </script>
</body>
</html>


        // 1. 核心定位函式
        function getLocation(isManual = false) {
            console.log(isManual ? "用戶主動請求定位..." : "系統初始嘗試定位...");
            
            map.locate({
                setView: true, 
                maxZoom: 16,
                enableHighAccuracy: true
            });
        }

        // 2. 定位成功：畫出定位點
        map.on('locationfound', function(e) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, {
                radius: 8, 
                fillColor: "#4285F4", 
                color: "white", 
                weight: 3, 
                opacity: 1, 
                fillOpacity: 1
            }).addTo(map);
        });

        // 3. 定位失敗：靜默處理，不驚嚇用戶
        map.on('locationerror', function(e) {
            console.log("定位未成功，原因：" + e.message);
            
            // 只有在用戶「主動點擊」且「權限被拒絕」的情況下，才給予溫馨提示
            // 否則保持靜默，讓用戶停留在起始畫面
            if (e.message.includes("denied")) {
                // 這裡可以用一個不干擾的小 Toast 或讓定位鈕閃爍一下，而非彈窗
                console.log("提示：請在瀏覽器設定中允許位置權限以開啟導航。");
            }
        });

        // 啟動時靜默嘗試一次
        window.onload = () => {
            getLocation(false); 
        };
        

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Glowy GO ! ç”Ÿæ´»åœˆé›·é”ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fdfaf5; font-family: -apple-system, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        /* ç¥ç€èˆ‡æ´»å‹•é» */
        .gmap-dot { background-color: #FFBF00; border: 2px solid #FFF; border-radius: 50%; width: 10px; height: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .event-dot { background-color: #FF5722; border: 2px solid #FFF; border-radius: 50%; width: 12px; height: 12px; box-shadow: 0 0 10px rgba(255,87,34,0.6); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* é›·é”æŒ‰éˆ• */
        .radar-btn {
            position: absolute; bottom: 100px; right: 20px; z-index: 1000;
            background: #FFBF00; color: white; border: none; width: 60px; height: 60px;
            border-radius: 50%; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        #status-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.75); color: white; padding: 8px 20px; border-radius: 30px; font-size: 12px;
        }
    </style>
</head>
<body>

    <button class="radar-btn" onclick="manualScan()">ğŸ“¡</button>
    <div id="status-bar">æ­£åœ¨å°‹æ‰¾æ‚¨çš„ç”Ÿæ´»åœˆ...</div>
    <div id="map"></div>

    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false, preferCanvas: true }).setView([25.056, 121.511], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const amberIcon = L.divIcon({ className: 'none', html: '<div class="gmap-dot"></div>', iconSize: [10, 10] });
        const eventIcon = L.divIcon({ className: 'none', html: '<div class="event-dot"></div>', iconSize: [12, 12] });
        
        const markerLayer = L.layerGroup().addTo(map);
        let userPos = null;

        // 1. è‡ªå‹•è¼‰å…¥ï¼šåŠå¾‘ 2km
        async function autoScan(latlng) {
            userPos = latlng;
            // 0.02 ç¶“ç·¯åº¦ç´„ç­‰æ–¼ 2km
            await fetchData(latlng.lat, latlng.lng, 0.02, "è‡ªå‹•åŒæ­¥ç”Ÿæ´»åœˆ");
        }

        // 2. æ‰‹å‹•è¼‰å…¥ï¼šæ“´å¤§ç¯„åœ (ç”±ç”¨æˆ¶é»æ“ŠæŒ‰éˆ•è§¸ç™¼)
        function manualScan() {
            const center = map.getCenter();
            fetchData(center.lat, center.lng, 0.05, "æ·±åº¦æ¢ç´¢ä¸­ (5km)");
        }

        async function fetchData(lat, lng, range, msg) {
            document.getElementById('status-bar').innerText = msg + "...";
            
            const query = `[out:json][timeout:15];(
                node["changing_table"](${lat - range},${lng - range},${lat + range},${lng + range});
                node["amenity"="events"](${lat - range},${lng - range},${lat + range},${lng + range});
            );out body 100;`;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                renderPoints(data.elements);
            } catch (e) {
                document.getElementById('status-bar').innerText = "è¨Šè™Ÿå¾®å¼±ï¼Œç¨å¾Œå†è©¦";
            }
        }

        function renderPoints(elements) {
            // ä¸æ¸…é™¤èˆŠçš„ï¼Œå¯¦ç¾è³‡æ–™ç–ŠåŠ 
            elements.forEach(el => {
                const icon = el.tags.amenity === 'events' ? eventIcon : amberIcon;
                L.marker([el.lat, el.lon], { icon: icon })
                 .bindPopup(`<b>${el.tags.name || 'ç¥ç€é»ä½'}</b>`)
                 .addTo(markerLayer);
            });
            document.getElementById('status-bar').innerText = `å·²é»äº®é€±é‚Š ${elements.length} å€‹ç²¾å½©ä½ç½®`;
        }

        // å®šä½ä¸¦å•Ÿå‹• 2km è‡ªå‹•æƒæ
        map.locate({setView: true, maxZoom: 15});
        map.on('locationfound', (e) => autoScan(e.latlng));

        // ç•¶ç”¨æˆ¶ç§»å‹•åœ°åœ–è¶…é 2kmï¼Œç‹€æ…‹æ¬„æé†’å¯ä»¥æ‰‹å‹•æƒæ
        map.on('moveend', () => {
            if (userPos && map.getCenter().distanceTo(userPos) > 2000) {
                document.getElementById('status-bar').innerText = "å·²é›¢é–‹æ ¸å¿ƒåœˆï¼Œé»æ“Šé›·é”æƒææ–°å€åŸŸ";
            }
        });
    </script>
</body>
</html>

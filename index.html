<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Glowy GO ! | çœŸå¯¦æ•¸æ“šé©…å‹•</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --amber: #FFBF00; --teal: #00838f; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: -apple-system, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* UI å±¤ç´š */
        .header-ui { position: absolute; top: calc(env(safe-area-inset-top) + 12px); left: 12px; right: 12px; z-index: 1000; }
        .search-row { display: flex; gap: 10px; align-items: center; }
        .sncf-bar { flex: 1; background: white; height: 50px; border-radius: 25px; display: flex; align-items: center; padding: 0 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .sncf-bar input { border: none; outline: none; width: 100%; font-size: 16px; }
        .profile-btn { width: 50px; height: 50px; border-radius: 50%; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid white; overflow: hidden; }

        /* æ¨™ç±¤åˆ— */
        .facility-tags { display: flex; gap: 8px; overflow-x: auto; margin-top: 12px; padding: 2px; }
        .tag { background: white; padding: 7px 16px; border-radius: 20px; font-size: 14px; white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; }
        .tag.active { background: var(--amber); color: white; }

        /* æµ®å‹•æ³¡æ³¡ï¼šç”Ÿå‘½å²æ„Ÿæ¡é›† */
        .bubble { 
            position: absolute; bottom: 260px; left: 50%; transform: translateX(-50%);
            width: 85%; background: white; border-radius: 24px; padding: 20px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.2); z-index: 3000; display: none;
        }

        .gps-fab { position: absolute; right: 16px; bottom: 180px; z-index: 1000; width: 56px; height: 56px; border-radius: 28px; background: white; border: none; font-size: 26px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 2000; background: white; border-top: 1px solid #eee; display: flex; height: 75px; padding-bottom: env(safe-area-inset-bottom); }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #666; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="header-ui">
        <div class="search-row">
            <div class="sncf-bar">
                <span>ğŸ”</span>
                <input type="text" id="search-input" placeholder="æ‰¾æ´»å‹•ã€æ¡é›†ç”Ÿå‘½å¯¶ç‰©..." onkeypress="if(event.key==='Enter') searchLocation()">
            </div>
            <div class="profile-btn"><img src="https://api.dicebear.com/7.x/micah/svg?seed=Glowy" style="width:100%"></div>
        </div>
        <div class="facility-tags" id="tag-container">
            <div class="tag" onclick="fetchFacilities('nursing_home')">ğŸ¼ å“ºä¹³å®¤</div>
            <div class="tag" onclick="fetchFacilities('toilets')">ğŸš» å…¬å»</div>
            <div class="tag" onclick="fetchFacilities('drinking_water')">ğŸš° é£²æ°´æ©Ÿ</div>
            <div class="tag" onclick="fetchFacilities('elevator')">ğŸ›— é›»æ¢¯</div>
        </div>
    </div>

    <div class="bubble" id="actBubble">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b id="bTitle" style="font-size:18px;">æ­£åœ¨åŠ è¼‰æ´»å‹•...</b>
            <span id="bWeather" style="color:orange; font-size:12px;">ğŸŒ¡ï¸ --Â°C</span>
        </div>
        <p id="bDesc" style="font-size:13px; color:#666;">ç”Ÿå‘½å²æ„Ÿæ¡é›†ï¼šè¨˜éŒ„èˆ‡å¯¶å¯¶çš„å†’éšªã€‚</p>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="launchNav()" style="flex:1; padding:12px; border-radius:12px; border:1px solid #ddd; background:none;">ğŸš€ å°èˆª</button>
            <button onclick="startCapture()" style="flex:1; padding:12px; border-radius:12px; border:none; background:var(--amber); color:white; font-weight:bold;">ğŸ’ æ¡é›†å¯¶ç‰©</button>
        </div>
    </div>

    <button class="gps-fab" onclick="map.locate({setView:true})">ğŸ¯</button>

    <nav class="bottom-nav">
        <div class="tab">ğŸ“<br>æ¢ç´¢</div>
        <div class="tab">ğŸ›’<br>å‘¨é‚Šæ”¯æ´</div>
        <div class="tab" onclick="reportIssue()">âœï¸<br>å…¬ç›Šè²¢ç»</div>
        <div class="tab">âš™ï¸<br>æœå‹™</div>
    </nav>

    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([25.0339, 121.5644], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        const dataLayer = L.layerGroup().addTo(map);

        // ğŸŸ¢ çœŸå¯¦æœå°‹ï¼šNominatim API
        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
            const data = await res.json();
            if (data[0]) {
                map.setView([data[0].lat, data[0].lon], 16);
                loadWeather(data[0].lat, data[0].lon);
            }
        }

        // ğŸŸ¢ çœŸå¯¦è¨­æ–½ä»‹æ¥ï¼šOverpass API (æŠ“å–å…¨çƒçœŸå¯¦è¨­æ–½)
        async function fetchFacilities(type) {
            dataLayer.clearLayers();
            const bounds = map.getBounds();
            const query = `[out:json];node["amenity"="${type}"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out;`;
            
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                data.elements.forEach(el => {
                    // é€æ˜å°é»ƒé»ï¼šä»£è¡¨è¨­æ–½
                    L.circleMarker([el.lat, el.lon], {
                        radius: 6, fillColor: '#FFBF00', color: '#fff', weight: 1, fillOpacity: 0.5
                    }).addTo(dataLayer).on('click', () => {
                        alert(`è¨­æ–½å…¬ç›Šå›å ±ï¼š${el.tags.name || 'æœªå‘½åè¨­æ–½'}\nè‹¥è³‡è¨Šæœ‰èª¤å¯é»æ“Šã€å…¬ç›Šè²¢ç»ã€‘è³ºå–ç¥ç€é»æ•¸ã€‚`);
                    });
                });
            } catch (e) { console.error("API é™åˆ¶é »ç‡ä¸­"); }
        }

        // ğŸŸ¢ çœŸå¯¦å¤©æ°£ï¼šOpen-Meteo
        async function loadWeather(lat, lng) {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
            const data = await res.json();
            document.getElementById('bWeather').innerText = `ğŸŒ¡ï¸ ${Math.round(data.current_weather.temperature)}Â°C`;
        }

        // ğŸŸ¢ ç”Ÿå‘½å²æ„Ÿæ¡é›†å‹•ä½œ
        function startCapture() {
            alert("é€²å…¥æ¡é›†é é¢ï¼šè«‹ä¸Šå‚³ç…§ç‰‡æˆ–å½±ç‰‡å®Œæˆç”Ÿå‘½å²æ„Ÿç´€éŒ„ï¼");
            // å¯¦éš›æ‡‰è·³è½‰è‡³ï¼šcamera.html
        }

        function reportIssue() {
            alert("å…¬ç›Šè²¢ç»æ©Ÿåˆ¶ï¼šå›å ±è¨­æ–½æå£æˆ–æ¬é·ï¼Œç²å¾—ç¥ç€é»æ•¸ï¼");
        }

        // æ¨¡æ“¬ä¸€å€‹ç¥ç€è‰²æ´»å‹•é» (å¯¶ç‰©)
        const treasure = L.circleMarker([25.035, 121.567], { radius: 12, fillColor: '#FFBF00', color: '#fff', weight: 3, fillOpacity: 1 }).addTo(map);
        treasure.on('click', () => {
            document.getElementById('bTitle').innerText = "å¯¶å¯¶è—è¡“å·¥ä½œåŠ";
            document.getElementById('actBubble').style.display = 'block';
            loadWeather(25.035, 121.567);
        });

        map.on('click', () => document.getElementById('actBubble').style.display = 'none');
    </script>
</body>
</html>
